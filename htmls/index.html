<!DOCTYPE html>
<html>

<head>
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
</head>

<body>
<canvas id="mainCanvas"></canvas>
<script>
    // 获取canvas
    const canvas = document.getElementById('mainCanvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const context = canvas.getContext('2d');
    // canvas.width = 1045
    // canvas.height = 735
    canvas.width = {{ .w }}
    canvas.height = {{ .h }}

    // 是否绘制下一帧（控制帧数）
    function nextFrame() {
        let interval = Math.floor(1000 / {{ .fps }})
        dt = new Date();
        let curTime = dt.getMilliseconds()
        if (curTime - lastTime >= interval || curTime - lastTime < -interval) {
            lastTime = curTime
            return true
        } else {
            return false
        }
    }

    var lastTime = 0

    // var frames = 0

    // 绘制（主函数）
    function drawFrame() {
        if (nextFrame()) {
            frames = getReq("http://{{ .ip }}:{{ .port }}/newFrame/", loadImg)
        }
        requestAnimationFrame(drawFrame);
    }
    requestAnimationFrame(drawFrame);

    function loadImg(code) {
        sleep(100)
        var img = new Image();
        img.src = "http://{{ .ip }}:{{ .port }}/frames/" + code.code + ".png"
        img.onload = function () {
            context.drawImage(img, 0, 0);
        };
    }

    function getReq(url, callback) {
        fetch(url, {
            method: 'GET',
            mode: 'cors',
            cache: "no-cache",
            redirect: 'follow',
        }).then((response) => response.json())
            // .then((data) => {
            //     var resp = data
            // })
            .then(callback)
            .catch(
                function (err) {
                    console.log('Fetch Error: ', err);
                }
            );
        // return resp

    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }


</script>
</body>

</html>